<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘é–€é«˜ç²± RWA äº¤æ˜“å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        .admin-section { display: none; }
        .user-section { display: block; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">ğŸ¶ é‡‘é–€é«˜ç²± RWA å¹³å°</h1>
            <button id="connectButton" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg font-semibold transition">
                é€£çµéŒ¢åŒ…
            </button>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border-l-4 border-blue-500">
            <p id="accountDisplay">éŒ¢åŒ…ç‹€æ…‹ï¼šæœªé€£ç·š</p>
            <p id="roleDisplay" class="font-bold text-blue-700"></p>
        </div>

        <section id="adminPanel" class="admin-section bg-red-50 p-6 rounded-xl border border-red-200 mb-6">
            <h2 class="text-2xl font-bold text-red-800 mb-4">ğŸ›¡ï¸ é…’å» ç®¡ç†æ§åˆ¶å° (Admin)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input id="mintTo" type="text" placeholder="æ¥æ”¶è€…åœ°å€ (0x...)" class="p-2 border rounded">
                <input id="mintYear" type="number" placeholder="å…¥åº«å¹´ä»½ (å¦‚ 2024)" class="p-2 border rounded">
                <input id="mintCategory" type="text" placeholder="é…’é¡åç¨± (å¦‚ é™³å¹´å¤§æ›²)" class="p-2 border rounded">
                <input id="mintLocation" type="text" placeholder="çª–è—ä½ç½® (å¦‚ ç¶“æ­¦é…’çª–)" class="p-2 border rounded">
                <button onclick="mintAsset()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">åŸ·è¡Œå¯¦ç‰©å…¥åº« (Mint)</button>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-4">ğŸ” çª–è—è³‡ç”¢æŸ¥è©¢</h2>
            <div class="flex gap-2 mb-4">
                <input id="searchId" type="number" placeholder="è¼¸å…¥ Token ID" class="flex-1 p-2 border rounded">
                <button onclick="getLiquorInfo()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">æŸ¥è©¢</button>
            </div>
            <div id="resultArea" class="p-4 bg-gray-100 rounded hidden">
                </div>
        </section>
    </main>

    <script>
        // åˆç´„è³‡è¨Š 
        const contractAddress = "0xd9145CCE52D386f254917e481eB44e9943F39138"; 
        const abi = [
            "function owner() view returns (address)",
            "function liquorDetails(uint256) view returns (uint256 year, string category, string location)",
            "function mintLiquorAsset(address to, uint256 _year, string _category, string _location) public",
            "function balanceOf(address owner) view returns (uint256)"
        ];

        let provider, signer, contract;

        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connectButton').addEventListener('click', connectWallet);
            } else {
                alert("è«‹å®‰è£ MetaMask!");
            }
        }

        async function connectWallet() {
            const accounts = await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            const userAddress = accounts[0];
            
            document.getElementById('accountDisplay').innerText = `éŒ¢åŒ…åœ°å€: ${userAddress}`;
            document.getElementById('connectButton').innerText = "å·²é€£ç·š";
            
            contract = new ethers.Contract(contractAddress, abi, signer);
            checkRole(userAddress);
        }

        async function checkRole(address) {
            try {
                const contractOwner = await contract.owner();
                const roleDisplay = document.getElementById('roleDisplay');
                const adminPanel = document.getElementById('adminPanel');

                if (address.toLowerCase() === contractOwner.toLowerCase()) {
                    roleDisplay.innerText = "èº«åˆ†è¾¨è­˜ï¼šç³»çµ±ç®¡ç†å“¡ (é…’å» ä¸­å¿ƒ)";
                    adminPanel.style.display = "block";
                } else {
                    // é€™è£¡ç¤ºç¯„ VIP é‚è¼¯ï¼šæŒæœ‰è¶…é 0 ç½ˆé…’å³ç‚º VIP
                    const balance = await contract.balanceOf(address);
                    roleDisplay.innerText = balance > 0 ? "èº«åˆ†è¾¨è­˜ï¼šå°Šæ¦® VIP è—å®¶" : "èº«åˆ†è¾¨è­˜ï¼šä¸€èˆ¬è¨ªå®¢";
                }
            } catch (err) {
                console.error("è§’è‰²åˆ¤å®šå¤±æ•—", err);
            }
        }

        async function mintAsset() {
            try {
                const to = document.getElementById('mintTo').value;
                const year = document.getElementById('mintYear').value;
                const cat = document.getElementById('mintCategory').value;
                const loc = document.getElementById('mintLocation').value;

                const tx = await contract.mintLiquorAsset(to, year, cat, loc);
                alert("äº¤æ˜“å·²ç™¼é€ï¼Œç­‰å¾…å€å¡Šç¢ºèª...");
                await tx.wait();
                alert("å…¥åº«æˆåŠŸï¼");
            } catch (err) {
                alert("éŒ¯èª¤: " + err.reason);
            }
        }

        async function getLiquorInfo() {
            const id = document.getElementById('searchId').value;
            const resArea = document.getElementById('resultArea');
            try {
                const info = await contract.liquorDetails(id);
                resArea.classList.remove('hidden');
                resArea.innerHTML = `
                    <p>ğŸ¶ é¡åˆ¥ï¼š${info.category}</p>
                    <p>ğŸ“… å¹´ä»½ï¼š${info.year} å¹´</p>
                    <p>ğŸ“ çª–è—åœ°é»ï¼š${info.location}</p>
                `;
            } catch (err) {
                alert("æ‰¾ä¸åˆ°æ­¤è³‡ç”¢");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
