<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘é–€é«˜ç²± RWA çª–è—å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <nav class="bg-indigo-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider">ğŸ¥ƒ KKL-RWA PLATFORM</h1>
            <button id="connectBtn" class="bg-amber-500 hover:bg-amber-600 px-6 py-2 rounded-full font-bold transition-all shadow-md">
                é€£çµéŒ¢åŒ…
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="glass-card rounded-2xl p-6 shadow-sm border border-slate-200 mb-6 flex flex-wrap items-center justify-between">
            <div>
                <p class="text-slate-500 text-sm">ç•¶å‰éŒ¢åŒ…åœ°å€</p>
                <p id="userAccount" class="font-mono text-indigo-900 font-bold">å°šæœªé€£æ¥</p>
            </div>
            <div id="roleBadge" class="mt-2 md:mt-0 px-4 py-1 rounded-full text-sm font-bold bg-slate-200 text-slate-600">
                è¨ªå®¢æ¨¡å¼
            </div>
        </div>

        <section id="adminPanel" class="hidden mb-8">
            <div class="bg-white rounded-2xl p-8 border-2 border-red-100 shadow-xl">
                <h2 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">ğŸ›¡ï¸ ç®¡ç†è€…æ¬Šé™ (Owner Only)</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold">1. é‘„é€ é«˜ç²±é…’æ¬Š (Mint NFT)</h4>
                        <input id="mintTo" type="text" placeholder="æ¥æ”¶è€…åœ°å€" class="w-full p-2 border rounded-lg">
                        <input id="mintYear" type="number" placeholder="å¹´ä»½ (å¦‚ 2024)" class="w-full p-2 border rounded-lg">
                        <button onclick="mintToken()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">ç¢ºèªä¸Šéˆ</button>
                    </div>
                    <div class="space-y-4 border-l pl-6">
                        <h4 class="font-bold">2. æ¬Šé™è¨­å®š</h4>
                        <input id="vipAddress" type="text" placeholder="ç›®æ¨™åœ°å€" class="w-full p-2 border rounded-lg">
                        <div class="flex gap-2">
                            <button onclick="setVIP(true)" class="flex-1 bg-amber-500 text-white py-2 rounded-lg">è¨­ç‚º VIP</button>
                            <button onclick="setVIP(false)" class="flex-1 bg-slate-400 text-white py-2 rounded-lg">å–æ¶ˆ VIP</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="vipPanel" class="hidden mb-8">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-500 rounded-2xl p-8 text-white shadow-xl">
                <div class="flex items-center gap-4">
                    <span class="text-4xl">ğŸŒŸ</span>
                    <div>
                        <h2 class="text-2xl font-bold">å°Šæ¦® VIP å°ˆå€</h2>
                        <p class="opacity-90">æ‚¨å¯ä»¥å„ªå…ˆæŸ¥çœ‹ä»Šå¹´åº¦ã€Œé™³å¹´åŸé…’ã€çš„åº«å­˜åˆ†æèˆ‡é å”®è¨ˆç•«ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-xl font-bold mb-4 text-slate-700 italic">My Collection / æˆ‘çš„çª–è—</h3>
            <div id="myAssets" class="grid md:grid-cols-3 gap-6 text-center text-slate-400 py-10 border-2 border-dashed rounded-2xl">
                å°šæœªé€£æ¥éŒ¢åŒ…æˆ–ç›®å‰ç„¡çª–è—è³‡ç”¢
            </div>
        </section>
    </main>

    <script>
        // --- è¨­å®šå€ ---
        const CONTRACT_ADDRESS = "0xf8e81D47203A594245E36C48e151709F0C19fBe8"; 
        const ABI = [
            "function owner() view returns (address)",
            "function isVIP(address) view returns (bool)",
            "function mintLiquorToken(address to, uint16 _year, uint8 _pct, string memory _batch) public",
            "function setVIPStatus(address _user, bool _status) public",
            "function balanceOf(address owner) view returns (uint256)"
        ];

        let provider, signer, contract;

        // --- é€£æ¥é‚è¼¯ ---
        async function connectWallet() {
            if (!window.ethereum) {
                alert("è«‹å®‰è£ MetaMask éŒ¢åŒ…ï¼");
                return;
            }
            try {
                // 1. è«‹æ±‚å¸³è™Ÿ
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];
                
                // 2. åˆå§‹åŒ– Ethers
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                // 3. UI æ›´æ–°
                document.getElementById('userAccount').innerText = address;
                document.getElementById('connectBtn').innerText = "å·²é€£æ¥";
                document.getElementById('connectBtn').classList.replace('bg-amber-500', 'bg-green-500');

                checkIdentity(address);
            } catch (error) {
                console.error("é€£æ¥å¤±æ•—:", error);
                alert("é€£æ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸»æ§å°ã€‚");
            }
        }

        // --- èº«ä»½åˆ¤æ–· ---
        async function checkIdentity(address) {
            try {
                const ownerAddress = await contract.owner();
                const vipStatus = await contract.isVIP(address);
                
                const badge = document.getElementById('roleBadge');
                const adminSection = document.getElementById('adminPanel');
                const vipSection = document.getElementById('vipPanel');

                // éš±è—æ‰€æœ‰ç‰¹æ®Šå€å¡Š
                adminSection.classList.add('hidden');
                vipSection.classList.add('hidden');

                if (address.toLowerCase() === ownerAddress.toLowerCase()) {
                    badge.innerText = "ğŸ‘‘ æœ€é«˜ç®¡ç†è€…";
                    badge.className = "px-4 py-1 rounded-full text-sm font-bold bg-red-500 text-white";
                    adminSection.classList.remove('hidden');
                } else if (vipStatus) {
                    badge.innerText = "ğŸ’ VIP æœƒå“¡";
                    badge.className = "px-4 py-1 rounded-full text-sm font-bold bg-amber-400 text-indigo-900";
                    vipSection.classList.remove('hidden');
                } else {
                    badge.innerText = "ğŸ‘¤ ä¸€èˆ¬ä½¿ç”¨è€…";
                    badge.className = "px-4 py-1 rounded-full text-sm font-bold bg-indigo-100 text-indigo-700";
                }
            } catch (err) {
                console.error("èº«ä»½é©—è­‰å¤±æ•—", err);
            }
        }

        // --- ç®¡ç†è€…åŠŸèƒ½ ---
        async function setVIP(status) {
            const target = document.getElementById('vipAddress').value;
            if(!target) return alert("è«‹è¼¸å…¥åœ°å€");
            try {
                const tx = await contract.setVIPStatus(target, status);
                await tx.wait();
                alert("æ¬Šé™æ›´æ–°æˆåŠŸï¼");
            } catch (err) { alert("æ“ä½œå¤±æ•—: " + err.reason); }
        }

        async function mintToken() {
            const to = document.getElementById('mintTo').value;
            const year = document.getElementById('mintYear').value;
            try {
                const tx = await contract.mintLiquorToken(to, year, 58, "BATCH-2024");
                await tx.wait();
                alert("é‘„é€ æˆåŠŸï¼é…’æ¬Šå·²ä¸Šéˆã€‚");
            } catch (err) { alert("é‘„é€ å¤±æ•—: " + err.reason); }
        }

        // ç›£è½éŒ¢åŒ…åˆ‡æ›
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        document.getElementById('connectBtn').addEventListener('click', connectWallet);
    </script>
</body>
</html>
