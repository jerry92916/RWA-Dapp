<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 æ¶ç´…åŒ… DApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-8 border-red-500">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">ğŸ§§ å€å¡Šéˆç´…åŒ…</h1>
        <p class="text-center text-gray-500 mb-6 text-sm">åˆç´„åœ°å€: <span id="contractAddr" class="font-mono bg-gray-100 p-1">0x45753...101d9</span></p>

        <div class="bg-red-50 p-4 rounded-lg mb-6 border border-red-100">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">é€£ç·šç‹€æ…‹:</span>
                <span id="status" class="font-bold text-red-600">æœªé€£ç·š</span>
            </div>
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">å¸³æˆ¶åœ°å€:</span>
                <span id="account" class="font-mono text-gray-800">n/a</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">ç›®å‰é¤˜é¡:</span>
                <span id="balance" class="font-bold text-gray-800">-- ETH</span>
            </div>
        </div>

        <button id="connectBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mb-3">
            1. é€£æ¥ MetaMask
        </button>
        
        <button id="claimBtn" disabled class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-4 px-4 rounded-lg transition duration-200 shadow-lg uppercase tracking-wider">
            2. ç«‹å³æ¶ç´…åŒ…ï¼
        </button>

        <div id="logBox" class="mt-6 text-xs bg-gray-900 text-green-400 p-3 rounded font-mono h-32 overflow-y-auto">
            > ç³»çµ±æº–å‚™å°±ç·’ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…...
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const CONTRACT_ADDRESS = "0x45753cDC8e467031339F5B244FbE1f0C21A101d9";
        
        // ğŸš¨ é‡è¦ï¼šé€™è£¡å¿…é ˆèˆ‡ä½ æ™ºèƒ½åˆç´„ä¸­çš„ function åç¨±å®Œå…¨ä¸€è‡´
        // å‡è¨­ä½ çš„åˆç´„ä¸­é ˜ç´…åŒ…çš„ function å« claim
        const ABI = [
            "function claim() public",
            "function getRemainingAmount() public view returns (uint256)"
        ];

        let provider, signer, contract;

        // UI å…ƒä»¶
        const connectBtn = document.getElementById('connectBtn');
        const claimBtn = document.getElementById('claimBtn');
        const logBox = document.getElementById('logBox');
        const statusEl = document.getElementById('status');
        const accountEl = document.getElementById('account');
        const balanceEl = document.getElementById('balance');

        // æ—¥èªŒå‡½æ•¸
        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div class="mb-1 text-gray-500">[${time}]</div><div class="mb-2 text-green-400">${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // 1. é€£æ¥éŒ¢åŒ…é‚è¼¯
        async function connectWallet() {
            if (!window.ethereum) {
                addLog("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° MetaMaskï¼è«‹å…ˆå®‰è£ã€‚");
                return;
            }

            try {
                addLog("æ­£åœ¨è«‹æ±‚éŒ¢åŒ…æˆæ¬Š...");
                // åˆå§‹åŒ– ethers v6 BrowserProvider
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // å¼·åˆ¶è·³å‡º MetaMask è«‹æ±‚é€£ç·š
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                // æ›´æ–° UI
                statusEl.innerText = "å·²é€£ç·š";
                statusEl.classList.replace('text-red-600', 'text-green-600');
                accountEl.innerText = `${address.slice(0, 6)}...${address.slice(-4)}`;
                
                // ç²å–é¤˜é¡
                const balance = await provider.getBalance(address);
                balanceEl.innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
                
                addLog(`é€£ç·šæˆåŠŸï¼åœ°å€: ${address}`);
                
                // å•Ÿç”¨æ¶ç´…åŒ…æŒ‰éˆ•
                connectBtn.classList.add('hidden');
                claimBtn.disabled = false;

                // åˆå§‹åŒ–åˆç´„ç‰©ä»¶
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

            } catch (error) {
                console.error(error);
                addLog(`é€£ç·šå¤±æ•—: ${error.message}`);
            }
        }

        // 2. æ¶ç´…åŒ…é‚è¼¯
        async function handleClaim() {
            if (!contract) return;

            try {
                claimBtn.disabled = true;
                claimBtn.innerText = "è™•ç†ä¸­...";
                addLog("æ­£åœ¨ç™¼èµ·åˆç´„äº¤æ˜“...");

                // å‘¼å«åˆç´„ claim å‡½å¼
                const tx = await contract.claim();
                addLog(`äº¤æ˜“å·²æäº¤ï¼Hash: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="underline">${tx.hash.slice(0,10)}...</a>`);

                addLog("ç­‰å¾…å€å¡Šç¢ºèª (å¯èƒ½éœ€è¦ 15-30 ç§’)...");
                const receipt = await tx.wait(); // ç­‰å¾…äº¤æ˜“æ‰“åŒ…

                if (receipt.status === 1) {
                    addLog("âœ… æ­å–œï¼ç´…åŒ…å·²æˆåŠŸé ˜å–ï¼");
                    alert("ğŸ‰ é ˜å–æˆåŠŸï¼");
                } else {
                    addLog("âŒ äº¤æ˜“å¤±æ•—ï¼Œè«‹æª¢æŸ¥åˆç´„é‚è¼¯ã€‚");
                }

            } catch (error) {
                console.error(error);
                // è™•ç†å¸¸è¦‹éŒ¯èª¤
                if (error.code === 'ACTION_REJECTED') {
                    addLog("ä½¿ç”¨è€…æ‹’çµ•äº†äº¤æ˜“ç°½åã€‚");
                } else {
                    addLog(`éŒ¯èª¤ï¼š${error.reason || error.message}`);
                }
            } finally {
                claimBtn.disabled = false;
                claimBtn.innerText = "2. ç«‹å³æ¶ç´…åŒ…ï¼";
            }
        }

        // ç¶å®šäº‹ä»¶
        connectBtn.addEventListener('click', connectWallet);
        claimBtn.addEventListener('click', handleClaim);

        // ç›£è½éŒ¢åŒ…åˆ‡æ›
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
    </script>
</body>
</html>
